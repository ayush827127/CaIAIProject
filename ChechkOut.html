<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Purchase Checkout</title>
    <link rel="stylesheet" href="style.css">
    <!-- Include Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script
        src="https://www.paypal.com/sdk/js?client-id=AUf6Jh8viomIa90m8KMFndz2iIwKkIcpzZHTUmKY1f8M9J7uDeQ1zO7d-lTb85AU4oiBHBlb2mBZ9g9_"></script>
    <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-database.js"></script>
</head>
<style>
    .active {
        background-color: rgb(59, 130, 246);
        color: black;
    }

    .active span {
        color: black;
    }

    .active h2 {
        color: white;
    }
</style>

<body>
    <header>
        <div id="header" class="z-10 w-full">

            <div id="banner" class="flex w-full justify-between px-4">
                <div class="flex">
                    <a href="index.html">
                        <img class="h-[80px]" src="Cal_ai_orign-removebg-preview.png" alt="">
                    </a>
                    <p class="relative top-[-8px] left-[-20px] text-[55px] font-light"><a href="index.html">&vert;</a>
                    </p>
                    <h1 class="relative top-5 text-[#074D8D] text-[25px] font-bold md:text-[18px] "><a
                            href="index.html">California Artificial Intelligence Institute</a></h1>
                </div>

                <div>
                    <p class="mt-7 md:hidden  relative text-[1rem] text-[#074D8D] font-bold md:hidden">Email: Info@calai.org</p>
                </div>
            </div>
            <div class="w-full h-[2px] bg-black"></div>
        </div>
    </header>
    <!-- <div class="container mx-auto px-4 text-center w-4/5">
        <h2 class="text-2xl font-bold mb-2 text-blue-800">Payment Information</h2>
        <p class="text-lg mb-3" style="font-size: 16px;">Thank you for registering for the program Certified Artificial
            Intelligence Engineer
            (CAIE™). We want to customize your learning experience by supporting you at every stage of your learning. To
            do that, please complete your payment formalities.</p>
    </div> -->

    <!-- <div class="container mx-auto px-4 text-center w-3/6">
        <h2 class="text-2xl font-bold mb-2 text-blue-800">Review & Confirm</h2>
        <p class="text-lg mb-3 " style="font-size: 22px;">Kindly review your program details before completing your
            payment to register for the course.</p>
    </div> -->

    <div class="container mx-auto text-center border-2 border-gray-400 rounded-lg mb-5 pb-4">
        <div class="addressBar flex justify-between rounded-lg  bg-gray-200" style=" justify-content: space-evenly; ">
            <div id="no1" class="flex w-4/5 items-center border rounded-lg p-2 m-2  " style="margin: -8px;">

                <div class="container mx-auto px-4 text-center w-4/5">
                    <h2 class="text-2xl font-bold mb-2 text-blue-800">Review & Confirm</h2>
                    <p class="text-lg mb-3 " style="font-size: 17px;">Kindly review your program details before
                        completing your
                        payment to register for the course.</p>
                </div>

            </div>

        </div>
        <div>
            <div class="text-center  m-3 p-5 mx-9 px-8 flex" style="margin-left: 250px; ">
                <div style=" width: 100%; text-align: left;">
                    <div class="mb-4 flex">
                        <h4 class="font-bold w-1/3">Program:</h4>
                        <span id="CourseName" class="w-2/3">Certified Artificial Intelligence Engineer (CAIE™)</span>
                    </div>
                    <div class="mb-4 flex" id="RegistrationFeeBox">
                        <h4 class="font-bold w-1/3">Registration Fee:</h4>
                        <span id="RegistrationFee" class="w-2/3">US $50</span>
                    </div>
                    <div class="mb-4 flex" id="TutionFeeBox">
                        <h4 class="font-bold w-1/3">Tution Fee:</h4>
                        <span id="TutionFee" class="w-2/3">US $449</span>
                    </div>
                    <div class="mb-4 flex">
                        <h4 class="font-bold w-1/3">Total Fee:</h4>
                        <span id="TotalFee" class="w-2/3">US $499</span>
                    </div>

                    <!-- Coupon Code Section -->
                    <div class="mb-5 flex" id="CouponSection">
                        <h2 class=" font-bold mb-2 w-1/3">Apply Coupon Code</h2>
                        <input type="text" id="couponCode" class="w-60 border border-gray-300 rounded-md p-2"
                            placeholder="Enter coupon code">
                        <button id="applyCoupon" class="bg-blue-500 text-white px-4 py-2 rounded-md ml-2">Apply</button>
                    </div>
                    <!-- Coupon Code Message -->
                    <div class="mb-5 flex">
                        <h2 class=" font-bold mb-2 w-1/3"></h2>
                        <p id="couponCodeMessage" class="text-green-400 hidden">CouponCode Applied successfully</p>
                    </div>

                    <!-- Checkboxes -->
                    <div class="mb-5">
                        <label class="flex items-center" id="registrationOnlyBox">
                            <input type="checkbox" class="form-checkbox" id="registrationOnly">
                            <span class="ml-2 px-3"> I just want to pay registration fee only</span>
                        </label>
                        <label class="flex items-center mb-2">
                            <input type="checkbox" class="form-checkbox" id="termsAndConditions">
                            <span class="ml-2 px-3"> I agree to the
                                <span style="color: blue;">Terms n Conditions </span> and
                                <span style="color: blue;">Privacy
                                    Policy</span></span>
                        </label>
                    </div>
                </div>


            </div>
            <!-- <button id="continue"
                class="bg-blue-800 hover:bg-blue-500 text-white rounded font-bold py-3 px-12 rounded">Continue</button> -->
            <div id="paypal-button-container" class="  py-3 px-12 " style="margin-left: 200px;"></div>

        </div>

    </div>

</body>

<script>
    var registrationFee;
    var TotalFee, TutionFee;
    var isregistrationFeePaid = true, isCourseFeePaid = true, isTotalFeePaid = true;

    // // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAoebNDGNMijYHlUWslnsmjYOnGUasKm2U",
        authDomain: "calai-5df45.firebaseapp.com",
        databaseURL: "https://calai-5df45-default-rtdb.firebaseio.com",
        projectId: "calai-5df45",
        storageBucket: "calai-5df45.appspot.com",
        messagingSenderId: "981887347929",
        appId: "1:981887347929:web:7184650cfb1092c362e2c8",
    };


    firebase.initializeApp(firebaseConfig);



    // Reference to the database
    var StudentRegistrationDB3 = firebase.database().ref("StudentRegistration");
    // Function to check if email exists in the database
    function checkEmailExists(email) {
        StudentRegistrationDB3.orderByChild("email").equalTo(email).once("value", function (snapshot) {
            if (snapshot.exists()) {
                // Log each data entry
                snapshot.forEach(function (childSnapshot) {
                    var data = childSnapshot.val();
                    console.log("Data:", data);

                    registrationFee = data.registrationFee;
                    TutionFee = parseInt(data.coursePrice.slice(1));
                    localStorage.setItem("Tutionfee", TutionFee);

                    //check if reigistration fee is paid or not
                    if (data.isregistrationFeePaid) {
                        document.getElementById("RegistrationFeeBox").style.display = "none";
                        document.getElementById('registrationOnlyBox').style.display = "none";
                        registrationFee = 0;

                    }


                    document.getElementById('TutionFee').innerText = "US $" + TutionFee;
                    // Calculate the total fee
                    TotalFee = registrationFee + TutionFee;

                    // Update the total fee element
                    document.getElementById("TotalFee").innerText = "US $" + TotalFee;

                    if (data.course === "CAID") {
                        document.getElementById("CourseName").innerText = "Certified Artificial Intelligence Developer (CAID TM)";
                    } else if (data.course === "CAIM") {
                        document.getElementById("CourseName").innerText = "Certified Artificial Intelligence Manager (CAIM TM)";
                    }
                    else {
                        document.getElementById("CourseName").innerText = "Certified Artificial Intelligence Leader (CAIL TM)";
                    }



                });
            }
        });
    }
    checkEmailExists(localStorage.getItem("email"))

    // Define a function to validate form details
    function validateForm() {
        var T_C_checkbox = document.getElementById('termsAndConditions');

        // Perform validation here, e.g., check if the inputs are not empty
        if (!T_C_checkbox.checked) {
            // If form details are invalid, show an alert message to the user
            alert('Please aggree our term n conditions');
            return false; // Return false to indicate validation failure
        }

        return true; // Return true to indicate validation success
    }
    var registration_checkbox = document.getElementById('registrationOnly')
    registration_checkbox.addEventListener("click", () => {
        if (registration_checkbox.checked) {
            TutionFee = 0;
            // Calculate the total fee
            document.getElementById("TutionFeeBox").style.display = "none";
            isCourseFeePaid = false;
            isTotalFeePaid = false;
            document.getElementById('couponCodeMessage').style.display = "none"
            document.getElementById('couponCode').value = "";
            document.getElementById("CouponSection").style.display = "none"
            renderScreen();
        }
        else {
            TutionFee = localStorage.getItem("Tutionfee");
            // Calculate the total fee
            isCourseFeePaid = true;
            isTotalFeePaid = true;
            document.getElementById("TutionFeeBox").style.display = "flex";
            document.getElementById("CouponSection").style.display = "flex"
            renderScreen();
        }
    })

    function renderScreen() {
        // Update the total fee element
        // Calculate the total fee
        document.getElementById("TutionFee").innerText = "US $" + TutionFee;
        TotalFee = registrationFee + parseInt(TutionFee);
        document.getElementById("TotalFee").innerText = "US $" + TotalFee;

    }

    renderScreen();

    var Paymentdatabase = firebase.database();

    // Function to save payment details
    function savePaymentDetails(email, paymentStatus, paymentDetails) {
        // Replace "email" with the actual email address
        var tableName = email.replace(".", "_").replace("#", "_");

        // Reference to the table based on email
        var emailTableRef = Paymentdatabase.ref(tableName);

        // Save payment details
        emailTableRef.push({
            status: paymentStatus,
            details: paymentDetails
        });
    }

      // Function to redirect to new webpage with payment details
      function redirectToPaymentPage(details) {
        // Construct URL with payment details
        var url = "paymentSuccessMessage.html?";
        url += "orderId=" + details.id; // Order ID
        url += "&transactionId=" + details.purchase_units[0].payments.captures[0].id; // Transaction ID
        url += "&TotalPaidAmount=" + TotalFee;

        // Redirect to new webpage
        window.location.href = url;
    }

    // // Render the PayPal button
    paypal.Buttons({
        onClick: function () {
            // Perform form validation when PayPal button is clicked
            if (!validateForm()) {
                // Form validation failed, prevent PayPal checkout
                return false;
            }
        },
        createOrder: function (data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: TotalFee // Certification Price
                    }
                }]
            });
        },
        onApprove: function (data, actions) {
            return actions.order.capture().then(function (details) {
                // Call your server to save the transaction
                console.log(details);
                // Submit the form after payment is captured
                updateDataByEmail(localStorage.getItem("email"), isregistrationFeePaid, isCourseFeePaid, isTotalFeePaid, localStorage.getItem("couponcode"), TotalFee);
                // Save payment details to Firebase
                savePaymentDetails(localStorage.getItem("email"), "success", details);
                redirectToPaymentPage(details)
            });
        },
        onCancel: function (data) {
            // Payment cancelled by the user
            console.log("Payment cancelled:", data);
            // Save payment details to Firebase
            savePaymentDetails(localStorage.getItem("email"), "cancelled", data);
        },
        onError: function (err) {
            // Payment error occurred
            console.error("Payment error:", err);
            // Save payment details to Firebase
            savePaymentDetails(localStorage.getItem("email"), "error", err);
        },
        onPending: function (data) {
            // Payment is pending
            console.log("Payment pending:", data);
            // Save payment details to Firebase
            savePaymentDetails(localStorage.getItem("email"), "pending", data);
        }
    }).render('#paypal-button-container');


    // Function to update the name field by email
    function updateDataByEmail(email, isregistrationFeePaid, isCourseFeePaid, isTotalFeePaid, couponcode, TotalPaidAmount) {
        StudentRegistrationDB3.orderByChild("email").equalTo(email).once("value", function (snapshot) {
            if (snapshot.exists()) {
                snapshot.forEach(function (childSnapshot) {
                    var key = childSnapshot.key; // Get the key of the record
                    StudentRegistrationDB3.child(key).update({ isregistrationFeePaid: isregistrationFeePaid }); // Update the name field
                    StudentRegistrationDB3.child(key).update({ isCourseFeePaid: isCourseFeePaid }); // Update the name field
                    StudentRegistrationDB3.child(key).update({ isTotalFeePaid: isTotalFeePaid }); // Update the name field
                    StudentRegistrationDB3.child(key).update({ couponcode: couponcode }); // Update the name field
                    StudentRegistrationDB3.child(key).update({ TotalPaidAmount: TotalPaidAmount });
                });
            } else {
                alert("Some error Happen payment not saved in database.");
            }
        });
    }

    //coupon code logic
    // Selecting the Apply Coupon button
    const applyCouponButton = document.getElementById('applyCoupon');

    // Adding click event listener to the Apply Coupon button
    applyCouponButton.addEventListener('click', function () {
        // Getting the value of the coupon code input field
        const couponCode = document.getElementById('couponCode').value;
        const CouponCode1 = "Scholarship60"
        const CouponCode2 = "Scholarship70"
        // Checking if the coupon code is valid
        if (couponCode === CouponCode1) {
            TutionFee = parseInt(localStorage.getItem("Tutionfee"));
            document.getElementById('couponCodeMessage').style.display = "flex"
            TutionFee = (TutionFee * 0.4).toFixed(0);
            localStorage.setItem("couponcode", CouponCode1)
            renderScreen()
        } else if (couponCode === CouponCode2) {
            TutionFee = parseInt(localStorage.getItem("Tutionfee"));
            document.getElementById('couponCodeMessage').style.display = "flex"
            TutionFee = (TutionFee * 0.3).toFixed(0);
            localStorage.setItem("couponcode", CouponCode2);
            renderScreen()
        } else {
            alert("Wrong coupon code")
        }



        // You can add further logic here, such as sending a request to validate the coupon code,
        // applying discounts, updating the UI, etc.
    });

</script>

</html>